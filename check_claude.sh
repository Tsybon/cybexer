#!/bin/bash

# ‚úÖ 1. –í–∏–¥–∞–ª–µ–Ω–Ω—è –≤–µ–±—à–µ–ª–∞ —Ç–∞ –ø–æ—à—É–∫ —ñ–Ω—à–∏—Ö

# –ü–æ—à—É–∫ –≤—Å—ñ—Ö –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏—Ö —à–µ–ª–æ–ø–æ–¥—ñ–±–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ (–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π PHP)
echo "–ü–æ—à—É–∫ –º–æ–∂–ª–∏–≤–∏—Ö –≤–µ–±—à–µ–ª—ñ–≤ (shell_exec, eval, base64_decode, system, exec, passthru) —É PHP —Ñ–∞–π–ª–∞—Ö..."
grep -r --include="*.php" -E "shell_exec|eval|base64_decode|system|exec|passthru" /var/www/

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –Ω–æ–≤—ñ –∞–±–æ –ø—ñ–¥–æ–∑—Ä—ñ–ª—ñ PHP —Ñ–∞–π–ª–∏ (—è–∫—ñ –∑–º—ñ–Ω–µ–Ω—ñ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤)
echo "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –ø—ñ–¥–æ–∑—Ä—ñ–ª—ñ —Ñ–∞–π–ª–∏, –∑–º—ñ–Ω–µ–Ω—ñ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤..."
find /var/www/ -type f -name "*.php" -mtime -7 -exec ls -l {} \;

# –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–Ω–∞–π–¥–µ–Ω–∏—Ö –≤–µ–±—à–µ–ª—ñ–≤ (—Å—Ç–≤–æ—Ä—é—î–º–æ —Ä–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é –ø–µ—Ä–µ–¥ –≤–∏–¥–∞–ª–µ–Ω–Ω—è–º)
echo "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó –ø—ñ–¥–æ–∑—Ä—ñ–ª–∏—Ö PHP —Ñ–∞–π–ª—ñ–≤ —É /tmp..."
grep -r --include="*.php" -E "shell_exec|eval|base64_decode|system|exec|passthru" /var/www/ | awk '{print $1}' | xargs -I {} cp {} /tmp/

echo "–í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–Ω–∞–π–¥–µ–Ω–∏—Ö –≤–µ–±—à–µ–ª—ñ–≤..."
grep -r --include="*.php" -E "shell_exec|eval|base64_decode|system|exec|passthru" /var/www/ | awk '{print $1}' | xargs rm -f

# üõ°Ô∏è 2. –û–±–º–µ–∂–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (–∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ç–∞ –ø–µ—Ä–º—ñ—à–µ–Ω–∏)

# –ó–∞–±–æ—Ä–æ–Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è PHP –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó uploads —Ç–∞ —ñ–Ω—à–∏—Ö –ø—É–±–ª—ñ—á–Ω–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è—Ö
#echo "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è .htaccess —Ñ–∞–π–ª—É –¥–ª—è –∑–∞–±–æ—Ä–æ–Ω–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è PHP —É /var/www/uploads/..."
#echo -e "<FilesMatch \"\\.php$\">\n  Deny from all\n</FilesMatch>" > /var/www/uploads/.htaccess

# –ê–±–æ —á–µ—Ä–µ–∑ Apache –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –¥–ª—è –∑–∞–±–æ—Ä–æ–Ω–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è PHP —É /var/www/uploads
#echo "–ó–∞–±–æ—Ä–æ–Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è PHP –≤ /var/www/uploads —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é Apache..."
#echo -e "<Directory /var/www/uploads>\n    php_admin_flag engine off\n</Directory>" >> /etc/apache2/apache2.conf

# –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Apache –¥–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω
#echo "–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Apache..."
#systemctl reload apache2

# üóÇÔ∏è 3. –ü–µ—Ä–º—ñ—à–µ–Ω–∏: –∑–º–µ–Ω—à–µ–Ω–Ω—è –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∞–≤ —Ç—ñ–ª—å–∫–∏ –Ω–∞ —á–∏—Ç–∞–Ω–Ω—è –¥–ª—è –≤—Å—ñ—Ö PHP —Ñ–∞–π–ª—ñ–≤
#echo "–ó–º—ñ–Ω–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –¥–ª—è PHP —Ñ–∞–π–ª—ñ–≤ –Ω–∞ 644..."
#find /var/www/ -type f -name "*.php" -exec chmod 644 {} \;

# üîí 1. –ó–∞–±–æ—Ä–æ–Ω–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ —Ç–∞ –ø–∞–ø–æ–∫ —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É

# –û–±–º–µ–∂–µ–Ω–Ω—è –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å —É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó /var/www/uploads
echo "–û–±–º–µ–∂–µ–Ω–Ω—è –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å —É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó /var/www/uploads..."
chmod 555 /var/www/uploads

echo "–ó–∞–≤–µ—Ä—à–µ–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ –¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞."
